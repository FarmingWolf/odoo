<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="estate_lease_contract_property_rental_detail_action" model="ir.actions.act_window">
        <field name="name">租金明细</field>
        <field name="res_model">estate.lease.contract.property.rental.detail</field>
        <field name="view_id" ref="estate_lease_contract_property_rental_detail_view_tree"/>
        <field name="view_mode">tree,form</field>
        <field name="context">{
            }
        </field>
        <field name="domain">[('active', '=', True), ('contract_state', 'in', ('released', 'to_be_released'))]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                这里显示资产租赁合同各期租金明细。
            </p>
        </field>
    </record>

    <record id="estate_lease_contract_property_rental_detail_view_tree" model="ir.ui.view">
        <field name="name">estate.lease.contract.property.rental.detail.tree</field>
        <field name="model">estate.lease.contract.property.rental.detail</field>
        <field name="arch" type="xml">
            <tree string="estate_lease_contract_property_rental_detail_view_tree"
                  create="context.get('contract_read_only')" delete="context.get('contract_read_only')"
                  edit="context.get('contract_read_only')"
                  decoration-info="edited and (rental_received &lt; 0.01) and (date_payment &gt;= (datetime.datetime.combine(context_today(), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-%d'))"
                  decoration-muted="rental_amount &lt; 0.01 and rental_receivable &lt; 0.01"
                  decoration-danger="((date_payment &lt; (datetime.datetime.combine(context_today(), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-%d')) and rental_received &lt; 0.01 and rental_amount &gt;= 0.01 and rental_receivable &gt; 0.01) or (rental_received &gt;= 0.01 and rental_receivable - rental_received &gt;= 0.01)"
                  decoration-warning="(rental_amount - rental_receivable &gt;= 0.01) or (rental_receivable - rental_amount &gt;= 0.01)"
                  decoration-success="rental_received &gt; 0 and (rental_received == rental_receivable or rental_received - rental_receivable &gt;= 0 or rental_receivable - rental_received &lt; 0.01)">
                <field name="edited" column_invisible="1"/>
                <field name="contract_id" column_invisible="1"/>
                <field name="property_id"/>
                <field name="renter_id"/>
                <field name="rental_period_no"/>
                <field name="period_date_from"/>
                <field name="period_date_to"/>
                <field name="period_days" sum="总计天数"/>
                <field name="date_payment"/>
                <field name="rental_amount" digits="[12, 2]" sum="总计租金"/>
                <field name="incentive_amount" digits="[12, 2]" sum="总计优惠"/>
                <field name="incentive_days" digits="[12, 0]" sum="总计优惠天数"/>
                <field name="rental_receivable" digits="[12, 2]" sum="总计应收"/>
                <field name="days_receivable" digits="[12, 0]" sum="总计应收天数"/>
                <button type="object" name="action_round" context="{'round_method': 'up2hundred', 'method_msg': '上取整至百位'}" title="上取整至百位" icon="fa-angle-double-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'round2hundred', 'method_msg': '四舍五入至百位'}" title="四舍五入至百位" icon="fa-angle-double-left" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'down2hundred', 'method_msg': '下取整至百位'}" title="下取整至百位" icon="fa-angle-double-down" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'up2ten', 'method_msg': '上取整至十位'}" title="上取整至十位" icon="fa-chevron-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'round2ten', 'method_msg': '四舍五入至十位'}" title="四舍五入至十位" icon="fa-chevron-left" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'down2ten', 'method_msg': '下取整至十位'}" title="下取整至十位" icon="fa-chevron-down" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'up2one', 'method_msg': '上取整至个位'}" title="上取整至个位" icon="fa-arrow-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'round2one', 'method_msg': '四舍五入至个位'}" title="四舍五入至个位" icon="fa-arrow-left" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'down2one', 'method_msg': '下取整至个位'}" title="下取整至个位" icon="fa-arrow-down" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <field name="rental_received" digits="[12, 2]" sum="总计实收"/>
                <button type="object" name="action_confirm_received" title="点击确认本期租金已收齐（等于本期应收）" icon="fa-thumbs-o-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <field name="rental_received_2_date"/>
                <field name="days_received" digits="[12, 0]" sum="总计实收天数"/>
                <field name="rental_arrears" digits="[12, 2]" sum="总计欠缴金额"/>
                <field name="days_arrears" digits="[12, 0]" sum="总计欠缴天数"/>
                <field name="description"/>
            </tree>
        </field>
    </record>

    <record id="estate_lease_contract_property_rental_detail_view_form" model="ir.ui.view">
        <field name="name">estate.lease.contract.property.rental.detail.form</field>
        <field name="model">estate.lease.contract.property.rental.detail</field>
        <field name="arch" type="xml">
            <form string="estate_lease_contract_property_rental_detail_view_form"
                  create="context.get('contract_read_only')" delete="context.get('contract_read_only')"
                  edit="context.get('contract_read_only')">
                <sheet>
                    <group col="4">
                        <group>
                            <field name="contract_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="property_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="rental_period_no"/>
                        </group>
                        <group>
                            <field name="edited_display" readonly="1" string=""/>
                        </group>
                    </group>
                    <group>
                        <field name="period_date_from" string="开始与结束日期" widget="daterange"
                               options="{'end_date_field': 'period_date_to'}"/>
                        <field name="period_date_to" invisible="1"/>
                    </group>

                    <group col="2">
                        <group>
                            <field name="date_payment"/>
                        </group>
                        <group>
                            <field name="period_days"/>
                        </group>
                    </group>
                    <group col="2">
                        <group>
                            <field name="rental_amount" digits="[12, 2]"/>
                        </group>
                        <group>
                            <field name="rental_amount_zh" readonly="1"/>
                        </group>
                    </group>
                    <group col="2">
                        <group>
                            <field name="incentive_amount" digits="[12, 2]"/>
                        </group>
                        <group>
                            <field name="incentive_days" digits="[12, 0]"/>
                        </group>
                    </group>
                    <group col="2">
                        <group>
                            <field name="rental_receivable" digits="[12, 2]"/>
                        </group>
                        <group>
                            <field name="days_receivable" digits="[12, 0]"/>
                        </group>
                    </group>
                    <group col="2">
                        <group>
                            <field name="rental_received" digits="[12, 2]"/>
                        </group>
                        <group>
                            <group>
                                <field name="days_received" digits="[12, 0]"/>
                            </group>
                            <group>
                                <field name="rental_received_2_date"/>
                            </group>
                        </group>
                    </group>
                    <group>
                        <field name="rental_detail_sub_ids">
                            <tree string="分次缴费明细" create="1" delete="1" edit="1" import="0" editable="bottom">
                                <field name="date_received"/>
                                <field name="rental_received" digits="[12, 2]"/>
                                <field name="rental_received_sum" digits="[12, 2]"/>
                                <field name="rental_arrears" digits="[12, 2]"/>
                                <field name="days_received" digits="[12, 0]"/>
                                <field name="days_received_sum" digits="[12, 0]"/>
                                <field name="days_arrears" digits="[12, 0]"/>
                                <field name="rental_received_2_date"/>
                            </tree>
                        </field>
                    </group>
                    <group col="2">
                        <group>
                            <field name="rental_arrears" digits="[12, 2]" readonly="1"/>
                        </group>
                        <group>
                            <field name="days_arrears" digits="[12, 0]"/>
                        </group>
                    </group>
                    <group>
                        <field name="description"/>
                    </group>
                    <group>
                        <field name="comment" placeholder="若修改本页内容，请填写备注！如：优惠政策描述等"/>
                    </group>
                    <button name="action_print_payment_notice" type="object" class="btn btn-primary"
                            icon="fa-file-pdf-o"
                            string="缴费通知单" title="点击打印缴费通知单"/>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <record id="estate_lease_contract_property_rental_detail_reminder_tree" model="ir.ui.view">
        <field name="name">租金催缴明细</field>
        <field name="model">estate.lease.contract.property.rental.detail</field>
        <field name="arch" type="xml">
            <tree string="租金催缴明细"
                  create="False" delete="False"
                  edit="context.get('contract_read_only')"
                  decoration-info="edited and (rental_received &lt; 0.01) and (date_payment &gt;= (datetime.datetime.combine(context_today(), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-%d'))"
                  decoration-muted="rental_amount &lt; 0.01 and rental_receivable &lt; 0.01"
                  decoration-danger="((date_payment &lt; (datetime.datetime.combine(context_today(), datetime.time(0,0,0)).to_utc()).strftime('%Y-%m-%d')) and rental_received &lt; 0.01 and rental_amount &gt;= 0.01 and rental_receivable &gt; 0.01) or (rental_received &gt;= 0.01 and rental_receivable - rental_received &gt;= 0.01)"
                  decoration-warning="(rental_amount - rental_receivable &gt;= 0.01) or (rental_receivable - rental_amount &gt;= 0.01)"
                  decoration-success="rental_received &gt; 0 and (rental_received == rental_receivable or rental_received - rental_receivable &gt;= 0 or rental_receivable - rental_received &lt; 0.01)">
                <field name="edited" column_invisible="1"/>
                <field name="contract_state" column_invisible="1"/>
                <field name="property_id"/>
                <field name="renter_id"/>
                <field name="renter_id_phone"/>
                <field name="renter_id_mobile"/>
                <field name="rental_period_no"/>
                <field name="period_date_from"/>
                <field name="period_date_to"/>
                <field name="period_days" sum="总计天数"/>
                <field name="date_payment"/>
                <field name="rental_amount" digits="[12, 2]" sum="总计租金"/>
                <field name="incentive_amount" digits="[12, 2]" sum="总计优惠"/>
                <field name="incentive_days" digits="[12, 0]" sum="优惠天数"/>
                <field name="rental_receivable" digits="[12, 2]" sum="总计应收"/>
                <field name="days_receivable" digits="[12, 0]" sum="总计应收天数"/>
                <button type="object" name="action_round" context="{'round_method': 'up2hundred', 'method_msg': '上取整至百位'}" title="上取整至百位" icon="fa-angle-double-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'round2hundred', 'method_msg': '四舍五入至百位'}" title="四舍五入至百位" icon="fa-angle-double-left" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'down2hundred', 'method_msg': '下取整至百位'}" title="下取整至百位" icon="fa-angle-double-down" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'up2ten', 'method_msg': '上取整至十位'}" title="上取整至十位" icon="fa-chevron-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'round2ten', 'method_msg': '四舍五入至十位'}" title="四舍五入至十位" icon="fa-chevron-left" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'down2ten', 'method_msg': '下取整至十位'}" title="下取整至十位" icon="fa-chevron-down" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'up2one', 'method_msg': '上取整至个位'}" title="上取整至个位" icon="fa-arrow-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'round2one', 'method_msg': '四舍五入至个位'}" title="四舍五入至个位" icon="fa-arrow-left" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <button type="object" name="action_round" context="{'round_method': 'down2one', 'method_msg': '下取整至个位'}" title="下取整至个位" icon="fa-arrow-down" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <field name="rental_received" digits="[12, 2]" sum="总计实收"/>
                <button type="object" name="action_confirm_received" title="点击确认本期租金已收齐（等于本期应收）" icon="fa-thumbs-o-up" groups="estate_lease_contract.estate_lease_contract_group_manager" help="点击后，如需撤销，请进入详情页面根据修改备注将相应字段修改回原值并保存"/>
                <field name="rental_received_2_date"/>
                <field name="days_received" digits="[12, 0]" sum="总计实收天数"/>
                <field name="rental_arrears" digits="[12, 2]" sum="总计欠缴金额"/>
                <field name="days_arrears" digits="[12, 0]" sum="总计欠缴天数"/>
            </tree>
        </field>
    </record>

    <record id="estate_lease_contract_property_rental_detail_reminder_action" model="ir.actions.act_window">
        <field name="name">租金催缴</field>
        <field name="res_model">estate.lease.contract.property.rental.detail</field>
        <field name="views">[False, "tree"]</field>
        <field name="view_id" ref="estate_lease_contract_property_rental_detail_reminder_tree"/>
        <field name="view_mode">tree,form,kanban</field>
        <field name="context">{
            'search_default_date_payment_2_this_month': True,
            'search_default_is_rental_arrears': True,
            }
        </field>
        <field name="domain">[('active', '=', True), ('contract_state', '=', 'released')]
        </field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                近期代缴费租金明细
            </p>
        </field>
    </record>

    <record id="estate_lease_contract_property_rental_detail_view_search" model="ir.ui.view">
        <field name="name">estate.lease.contract.property.rental.detail.view.search</field>
        <field name="model">estate.lease.contract.property.rental.detail</field>
        <field name="arch" type="xml">
            <search string="租金检索">
                <filter string="支付月份" name="date_payment_month" date="date_payment"/>
                <separator/>
                <filter string="截至本日" name="date_payment_2_today"
                        domain="[('date_payment', '&lt;=', context_today())]"/>
                <separator/>
                <filter string="截至本月" name="date_payment_2_this_month"
                        domain="[('date_payment', '&lt;', (context_today() + relativedelta(months=1, day=1)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="截至本年" name="date_payment_2_this_year"
                        domain="[('date_payment', '&lt;', (context_today() + relativedelta(years=1, month=1, day=1)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="有欠缴" name="is_rental_arrears" domain="[('rental_arrears', '&gt;=', 0.01)]"/>
                <filter string="无欠缴" name="no_rental_arrears" domain="[('rental_arrears', '&lt;', 0.01)]"/>
                <separator/>
                <field string='租赁标的名称' name="property_id"/>
                <searchpanel>
                    <field string='承租人文件夹' name="renter_id" context="{'group_by': 'property_id'}"/>
                </searchpanel>
            </search>
        </field>
    </record>

</odoo>
